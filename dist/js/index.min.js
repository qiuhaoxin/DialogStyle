!function(e,s){var i=s.documentElement,o=e.devicePixelRatio||1;function t(){i.clientWidth;i.style.fontSize="20px"}!function e(){s.body?s.body.style.fontSize=12*o+"px":s.addEventListener("DOMContentLoaded",e)}(),t(),window.addEventListener("resize",t),window.addEventListener("pageshow",function(e){if(2<=o){var t=s.createElement("body"),n=s.createElement("div");n.style.border=".5px solid transparent",t.appendChild(n),i.appendChild(t),1===n.offsetHeight&&i.classList.add("hairlines"),i.removeChild(t)}})}(window,document),function(e,t){"function"==typeof define&&define.amd?define([],t):"undefined"!=typeof module&&module.exports?module.exports=t():e.Socket=t()}(this,function(){if(!(!1 in window))return d.prototype={eventObj:{},onopen:function(e){},onclose:function(e){},onconnecting:function(e){},onmessage:function(e){this.eventObj.onmessage&&this.eventObj.onmessage(e.data)},onerror:function(e){},setEventCallBack:function(e){if(console.log("arguments is "+arguments.length),1<arguments.length)this.eventObj[e]=arguments[1];else for(var t in e)this.eventObj[t]=e[t]}},d.debugAll=!1,d.CONNECTING=WebSocket.CONNECTING,d.OPEN=WebSocket.OPEN,d.CLOSED=WebSocket.CLOSED,d.CLOSING=WebSocket.CLOSING,d;function d(e,t,n){var s={debug:!1,automaticOpen:!0,reconnectInterval:1e3,maxReconnectInterval:3e4,reconnectDecay:1.5,timeoutInterval:2e4,maxReconnectAttempts:100,binaryType:"blob",domObj:null};for(var i in n||(n={}),s)void 0!==n[i]?this[i]=n[i]:this[i]=s[i];this.url=e,this.reconnectAttempts=0,this.readyState=WebSocket.CONNECTING,this.protocol=null;var o,c=this,a=!1,l=document.createElement("div");function r(e,t){var n=document.createEvent("CustomEvent");return n.initCustomEvent(e,!1,!1,t),n}l.addEventListener("open",function(e){c.onopen(e)}),l.addEventListener("close",function(e){c.onclose(e)}),l.addEventListener("message",function(e){console.log("onmessage"),c.onmessage(e)}),l.addEventListener("error",function(e){c.onerror(e)}),l.addEventListener("connecting",function(e){c.onconnecting(e)}),this.addEventListener=l.addEventListener.bind(l),this.removeEventListener=l.removeEventListener.bind(l),this.dispatchEvent=l.dispatchEvent.bind(l),this.dataArr=[],this.open=function(s,n){if((o=new WebSocket(c.url,t||[])).binaryType=this.binaryType,s){if(this.maxReconnectAttempts&&this.reconnectAttempts>this.maxReconnectAttempts)return}else l.dispatchEvent(r("connecting")),this.reconnectAttempt=0;(c.debug||d.debugAll)&&console.debug("Socket");o.onopen=function(e){window.scoketTip.innerText="已连接服务器"+c.url,console.log("url is "+c.url),(c.debug||d.debugAll)&&console.debug("Socket","onopen",c.url),c.protocol=o.protocol,c.readyState=WebSocket.OPEN,c.reconnectAttempts=0;var t=r("open");t.isReconnect=!1,l.dispatchEvent(t),n&&n()},o.onclose=function(e){if(window.scoketTip.innerText="已关闭服务器链接"+c.url,o=null,a)c.readyState=WebSocket.CLOSED,l.dispatchEvent(r("close"));else{c.readyState=WebSocket.CONNECTING;var t=r("connecting");t.code=e.code,t.reason=e.reason,t.wasClean=e.wasClean,l.dispatchEvent(t),s||((c.debug||d.debugAll)&&console.debug("ReconnectingWebSocket","onclose",c.url),l.dispatchEvent(r("close")));var n=c.reconnectInterval*Math.pow(c.reconnectDecay,c.reconnectAttempts);setTimeout(function(){c.reconnectAttempts++,c.open(!0)},n>c.maxReconnectInterval?c.maxReconnectInterval:n)}},o.onmessage=function(e){(c.debug||d.debugAll)&&console.debug("Socket","onmessage",c.url,e.data);var t=r("message");t.data=e.data,l.dispatchEvent(t)},o.onerror=function(e){(c.debug||d.debugAll)&&console.debug("Socket","onerror",c.url,e),l.dispatchEvent(r("error"))}},this.automaticOpen&&this.open(!1),this.send=function(e){if(o)return(c.debug||d.debugAll)&&console.debug("Socket","send",c.url,e),o.send(e);throw"INVALID_STATE_ERR: Pasuing to reconnect!"},this.close=function(e,t){void 0===e&&(e=1e3),a=!0,o&&o.close(e,t)},this.refresh=function(){o&&o.close()}}}),function(e,t){"function"==typeof define&&define.amd?define([],t):"undefined"!=typeof module&&module.exports?module.exports=t():e.ChatList=t()}(this,function(){function o(e){return document.getElementById(e)}function c(e){return/^\s*$/.test(e)}var a=null,l=null,e=o("msg"),r=null,n=(Math,o("footer")),s=o("change"),i=o("changeVoice"),d=o("voice"),t=o("socket_tip");function u(e){var t=this;this.$btn=o("submit"),l=o("list"),a=document.querySelector(".footer input");var n=document.location,s="ws:";"https:"==n.protocol&&(s="wss:");var i=s+n.host+window.context+"/ws/api/chatbot";window.message="明天从深圳到北京出差后天返回",(r=new Socket(i)).setEventCallBack("onmessage",this.acceptMsg.bind(this)),r.open(!1,function(){var e=localStorage.getItem("storeState");if(console.log("StoreState is "+e),window.message&&!c(window.message)){localStorage.getItem("chatSessionId");t.mode=1,t.sendMessage(window.message),t.mode=0}}),this.init()}return window.scoketTip=t,u.prototype={x:0,y:0,mode:0,html:"",urlText:"",localId:0,voiceText:"",bindEvents:[],init:function(){var t=this,e=localStorage.getItem("storeState");(e&&(e=JSON.parse(e),this.html=e.htmlContent,window.chatSessionId=e.chatSessionId,localStorage.removeItem("storeState"),l.innerHTML=this.html,this.jump()),XuntongJSBridge.call("defback",{},function(){localStorage.removeItem("storeState"),XuntongJSBridge.call("closeWebView")}),this.wrapperH=document.body.clientHeight-44,this.wrapperW=document.body.clientWidth,this.$btn&&this.bindEvent(this.$btn,"click",this.sendMessage.bind(this)),a)&&this.bindEvent(a,"keyup",function(e){e.preventDefault(),13==e.keyCode&&t.sendMessage()});this.bindEvent(d,"click",this.speak.bind(this)),this.bindEvent(s,"click",function(e){var t=e.target;t.classList.contains("icon-voice")?(t.classList.remove("icon-voice"),t.classList.add("icon-voice-text")):t.classList.contains("icon-voice-text")&&(t.classList.remove("icon-voice-text"),t.classList.add("icon-voice")),n.classList.contains("change-lt")?(n.classList.remove("change-lt"),n.classList.add("change-v"),this.mode=1):n.classList.contains("change-v")&&(n.classList.remove("change-v"),n.classList.add("change-lt"),this.mode=0)}),this.bindEvent(i,"click",function(e){var t=e.target;t.classList.contains("icon-voice")?(t.classList.remove("icon-voice"),t.classList.add("icon-voice-text")):t.classList.contains("icon-voice-text")&&(t.classList.remove("icon-voice-text"),t.classList.add("icon-voice")),n.classList.contains("change-lt")?(n.classList.remove("change-lt"),n.classList.add("change-v"),this.mode=1):n.classList.contains("change-v")&&(n.classList.remove("change-v"),n.classList.add("change-lt"),this.mode=0)})},acceptMsg:function(e){e=JSON.parse(e);var t=document.createElement("LI");t.classList.add("msg-item"),this.dealType(e),t.innerHTML=this.urlText,t.cloneNode().innerHTML=this.urlText,l.appendChild(t),c(window.message)||(window.message=""),("TEXT"!=e.type.toUpperCase()||"TEXT"==e.type.toUpperCase()&&e.next&&"TEXT"!=e.next.type.toUpperCase())&&this.jump(),this.scroll(),this.html+="<li class='msg-item'>"+this.urlText+"</li>",c(this.voiceText)||this.playVoice(this.voiceText),this.urlText=""},playVoice:function(e){var t=this;try{XuntongJSBridge.call("voiceSynthesize",{text:e,voiceName:"xiaoyan"},function(e){if(1==e.success||"true"==e.success){t.localId=e.data.localId;e.data.len;XuntongJSBridge.call("playVoice",{localId:t.localId},function(e){t.voiceText=""})}})}catch(e){alert("playVoice is "+e)}},dealType:function(e){var s=this;switch(e.type.toUpperCase()){case"URL":var t=e.url;this.urlText="<div class='url-wrapper' data-url="+t.url+" data-event=url-"+(parseInt(this.bindEvents.length)+1)+"><span class='url-title'>"+t.title+"</span><span class='url-content'>"+t.content+"</span></div>",this.voiceText+=t.title+""+t.content;break;case"SELECTS":var n=e.selects;this.urlText="<ul class='custom-select' data-event=select-"+(parseInt(this.bindEvents.length)+1)+"><li class='title'>"+e.text+"</li>",this.voiceText+=e.text,n.forEach(function(e,t){for(var n in s.urlText+="<li class='custom-select-item' data-value='"+(parseInt(t)+1)+"'><span class='custom-select-index'>"+(parseInt(t)+1)+".</span>",e)s.voiceText+=parseInt(t)+1+""+e[n],s.urlText+="<span class='custom-select-"+n+"'>"+e[n]+"</span>";s.urlText+="</li>"}),this.urlText+="</ul>";break;case"TEXT":this.urlText='<div class="message new">'+e.text+"</div>",this.voiceText+=e.text;break;case"COMFIRM":console.log("confirm!"),this.urlText+="<div class='custom-confirm message new' data-event=confirm-"+(parseInt(this.bindEvents.length)+1)+"><div class='confirm-title'>"+e.text+"</div><div class='confirm-btn'><span class='confirm-sure'>是</span><span class='confirm-cancel'>否</span></div></div>",this.voiceText+=e.text}e.next&&arguments.callee.call(this,e.next)},isHavedBind:function(n){return console.log("bindEvb is "+JSON.stringify(this.bindEvents)),this.bindEvents.filter(function(e,t){return e.obj.getAttribute("data-event")==n.getAttribute("data-event")})},jump:function(){var i=this;console.log("jump");for(var e=document.querySelectorAll(".url-wrapper"),t=0,n=e.length;t<n;t++){var s=e[t];0<(a=i.isHavedBind(s)).length||(this.bindEvents.push({obj:s,eventName:"click"}),this.bindEvent(e[t],"click",function(e){i.stopPlayVoice();var t=e.target;"DIV"!=t.nodeName&&(t=t.parentNode);var n=t.getAttribute("data-url");if(n){var s={};s.chatSessionId=window.chatSessionId,s.htmlContent=i.html,localStorage.setItem("storeState",JSON.stringify(s)),location.href=n}}))}var o=document.querySelectorAll(".custom-select");for(t=0,n=o.length;t<n;t++){s=o[t];0<(a=i.isHavedBind(s)).length||(this.bindEvents.push({obj:s,eventName:"click"}),this.bindEvent(o[t],"click",function(e){var t=e.target;i.stopPlayVoice(),"SPAN"==t.nodeName&&(t=t.parentNode),null!=t.getAttribute("data-value")&&(console.log("value si "+t.getAttribute("data-value")),i.mode=1,i.sendMessage(t.getAttribute("data-value")))}))}var c=document.querySelectorAll(".custom-confirm");for(t=0,n=c.length;t<n;t++){s=c[t];var a=i.isHavedBind(s);console.log("result is "+a.length),0<a.length||(this.bindEvents.push({obj:s,eventName:"click"}),this.bindEvent(s,"click",function(e){var t=e.target;if(i.stopPlayVoice(),"SPAN"==t.nodeName){var n=t.innerText;n&&(i.mode=1,i.sendMessage(n))}}))}},scroll:function(){this.caculate(),l.scrollTop=l.scrollHeight+l.offsetHeight+50},caculate:function(){e.scrollHeight},clearInput:function(){a.value=""},speakCallBack:function(e){this.sendMessage(e.resultStr)},isYZJ:function(){return!!navigator.userAgent.match(/Qing\/.*;(iOS|iPhone|Android).*/)},stopPlayVoice:function(){var t=this;XuntongJSBridge.call("stopVoice",{localId:this.localId},function(e){"true"==String(e.success)&&(t.localId=0)})},speak:function(e){var n=this;if(this.isYZJ()){0!=this.localId&&this.stopPlayVoice();try{XuntongJSBridge.call("voiceRecognize",{},function(e){if("true"==e.success){n.mode=1;var t=e.data.text;if(c(t))return;t=t.replace(/[\ |\~|\，|\。|\`|\!|\@|\#|\$|\%|\^|\&|\*|\(|\)|\-|\_|\+|\=|\||\\|\[|\]|\{|\}|\;|\:|\"|\'|\,|\<|\.|\>|\/|\?]/g,""),n.sendMessage(t)}})}catch(e){}}else alert("请用云之家打开!")},sendMessage:function(e){console.log("contentn is "+e+" and mode is "+this.mode),0==this.mode&&(e=(e=a.value).replace(/[\ |\~|\，|\。|\`|\!|\@|\#|\$|\%|\^|\&|\*|\(|\)|\-|\_|\+|\=|\||\\|\[|\]|\{|\}|\;|\:|\"|\'|\,|\<|\.|\>|\/|\?]/g,""),console.log("cntent is "+e),c(e))||(this.insertMsg(0,e),r.send(JSON.stringify({sessionId:window.chatSessionId,message:e})),this.clearInput(),this.scroll(),1==this.mode&&(this.mode=0))},setDate:function(){var e=new Date,t=document.createElement("DIV");return t.innerHTML=e.getHours()+":"+e.getMinutes(),t},insertMsg:function(e,t){var n=document.createElement("LI");n.classList.add("msg-item");var s='<div class="message message-personal">'+t+"</div>";n.innerHTML=s,n.cloneNode().innerHTML=s,l.appendChild(n),this.html+="<li class='msg-item'>"+s+"</li>"},bindEvent:function(e,t,n){e.addEventListener(t,n||this,!1)},unbindEvent:function(e,t,n){e.removeEventListener(t,n||this,!1)}},u}),function(){if(!window.XuntongJSBridge){var a="xuntong",l=1,r={},e={invoke:t,call:t,handleMessageFromXT:function(e,t){try{var n=r[e];if(!n)return;n.apply(null,[t])}catch(e){alert(e)}}};window.XuntongJSBridge=e}function t(e,t,n){if(!(s=navigator.userAgent).match(/\(i[^;]+;( U;)? CPU.+Mac OS X/)&&!s.match(/Android/i)&&!navigator.userAgent.match(/App\/cloudhub/))return!1;var s,i=n&&"function"==typeof n,o=i?l++:0;i&&(r[o]=n);var c=document.createElement("IFRAME");c.setAttribute("src",a+":"+e+":"+o+":"+encodeURIComponent(JSON.stringify(t))),c.setAttribute("height","1px"),c.setAttribute("width","1px"),document.documentElement.appendChild(c),c.parentNode.removeChild(c),c=null}}();